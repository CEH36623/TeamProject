<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <meta charset="UTF-8">
  <title>Mars Triangular Plot</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
  <div class="position-absolute top-0 end-0 p-3" style="z-index: 10; width: 280px;">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-gradient bg-primary text-white fw-bold">
        ğŸª ë¶€ì§€ ì •ë³´
      </div>
      <div class="card-body">
        <img src="" id="plot-img" class="img-fluid rounded mb-2" style="display: none;" alt="ë¶€ì§€ ì´ë¯¸ì§€">
        <h6 class="text-muted" id="plot-info">ë¶€ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</h6>
        <p class="card-text" id="plot-description">ì„ íƒí•œ ë¶€ì§€ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì—¬ê¸°ì— ì“¸ ìˆ˜ ìˆì–´ìš”.</p>
        <button id="details-button" class="btn btn-outline-light btn-sm bg-primary text-white" style="display: none;">ìì„¸íˆ ë³´ê¸°</button>
      </div>
    </div>
  </div>
  <canvas id="canvas"></canvas>
<!--
  importmapì˜ ì—­í•  : import ì£¼ì†Œ ê°„ë‹¨í•˜ê²Œ í‘œí˜„

  import * as THREE from 'three';
  import * as THREE from 'https://unpkg.com/three@0.141.0/build/three.module.js';
  ì´ ë‘ê°œëŠ” ì‹¤ì§ˆì ìœ¼ë¡œ ê°™ìŒ. 

  "three" : 'https://unpkg.com/three@0.141.0/build/three.module.js';
  ì´ë ‡ê²Œ í•´ì„œ ê°„ë‹¨í•˜ê²Œ ë³´ì´ë ¤ê³ 
  -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.141.0/build/three.module.js",
        "GLTFLoader": "https://unpkg.com/three@0.141.0/examples/jsm/loaders/GLTFLoader.js",
        "OrbitControls": "https://unpkg.com/three@0.141.0/examples/jsm/controls/OrbitControls.js"
      }
    }
  </script>

  <script type="module">
// GLTFLoaderë¡œ Mars ëª¨ë¸ ë¡œë“œ ë° ë¶€ì§€ ìƒì„± í˜¸ì¶œ
import * as THREE from 'three';
import { GLTFLoader } from 'GLTFLoader';
import { OrbitControls } from 'OrbitControls';

// 4ê°œ ê¸°ë³¸ìš”ì†Œ ì´ˆê¸°í™”
// camera, renderer, controls, secne
//const : ì£¼ì†Œ ê³ ì •, ì†ì†¡ ê°€ë³€
const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
// ê¸°ë³¸ ìœ„ì¹˜
camera.position.set(0, 0, 3);

// ì„¸ì…˜ì— ì €ì¥ëœ ì¹´ë©”ë¼ ìƒíƒœê°€ ìˆë‹¤ë©´ ë³µì›
const savedPosition = sessionStorage.getItem('cameraPosition');
const savedRotation = sessionStorage.getItem('cameraRotation');
if (savedPosition && savedRotation) {
  const pos = JSON.parse(savedPosition);
  const rot = JSON.parse(savedRotation);
  camera.position.set(pos.x, pos.y, pos.z);
  camera.rotation.set(rot._x, rot._y, rot._z);
}

const renderer = new THREE.WebGLRenderer({ canvas: document.querySelector("#canvas"), antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.enableRotate = true; // ê¸°ë³¸ì ìœ¼ë¡œ íšŒì „ ê°€ëŠ¥
controls.dampingFactor = 0.05; // ê¸°ë³¸ê°’ì€ 0.1, ì‘ê²Œ ì„¤ì •í•˜ë©´ ëœ ë¯¸ë„ëŸ¬ì§
controls.rotateSpeed = 0.5; // íšŒì „ ì†ë„ë„ ì¡°ì ˆ
controls.zoomSpeed = 0.5;   // ì¤Œ ì†ë„ ì¡°ì ˆ
controls.panSpeed = 0.5;    // íŒ¬ ì†ë„ ì¡°ì ˆ

const scene = new THREE.Scene();


// ì¡°ëª… ì„¤ì •
//AmbientLight(ìƒ‰ìƒrgb, ì„¸ê¸°)
//AmbientLight(í°ìƒ‰, 0.7)
const ambientLight = new THREE.AmbientLight(0xffffff, 0.7); // ë¶€ë“œëŸ¬ìš´ ì „ì—­ ì¡°ëª…
scene.add(ambientLight);

// (ì‹œê°í™”ë¥¼ ìœ„í•œ) ì¡°ëª…ì„ ì¹´ë©”ë¼ ìª½ì—ì„œ ë¹„ì¶”ë„ë¡ í•˜ì—¬ ì „ì²´ê°€ ì˜ ë³´ì´ê²Œ í•¨
const directionalLight = new THREE.DirectionalLight(0xffffff, 2.0);
directionalLight.position.set(0, 0, 2); // ì¹´ë©”ë¼ ë°©í–¥
scene.add(directionalLight);
const plotMeshes = [];


//mars ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ê¸°
const loader = new GLTFLoader();
loader.load('mars/scene.gltf', function (gltf) { /*í™”ì„± íŒŒì¼ ë¶ˆëŸ¬ì™€ì„œ í…ìŠ¤ì³ ì…í˜.*/
    const mars = gltf.scene;
    mars.position.set(0, 0, 0);
    // í™”ì„± ëª¨ë¸ í¬ê¸°ë¥¼ ë¶€ì§€ ë°˜ì§€ë¦„ê³¼ ì¼ì¹˜ì‹œí‚´
    mars.scale.set(1, 1, 1);
    //ë Œë”ë§í• ë•Œ í™”ë©´ì— ë‚˜íƒ€ë‚˜ê²Œ ê°ì²´ ì¶”ê°€
    scene.add(mars);

    createPlots(mars);  // ëª¨ë¸ ë¡œë“œ í›„ ë¶€ì§€ ì‚¼ê°í˜• ìƒì„±
});

function createPlots(mars) {
    const radius = 1.0;
    const geometry = new THREE.IcosahedronGeometry(radius, 3); // Geodesic sphere with higher detail
    geometry.setIndex([...Array(geometry.getAttribute('position').count).keys()]);
    /* ë¹¨ê°„ì›ìœ¼ë¡œ ì‹œê°í™”ë¶€ë¶„ 
    const material = new THREE.MeshStandardMaterial({
        color: 0xff0000,
        side: THREE.DoubleSide,
        transparent: false,
        opacity: 1.0
    });
    */

    const positionAttribute = geometry.getAttribute('position');
    const indexAttribute = geometry.index;

    //ì •ì  ì¢Œí‘œ ì¶”ì¶œ
    for (let i = 0; i < indexAttribute.count; i += 3) {
        //ì‚¼ê°í˜•ì´ë‹ˆê¹Œ ì •ì  3ê°œ ì¶”ì¶œ
        const indices = [
            indexAttribute.getX(i),
            indexAttribute.getX(i + 1),
            indexAttribute.getX(i + 2)
        ];
        //vectorë¡œ ë³€í™˜í•¨
        //multiplyScalarë¡œ êµ¬ ë°˜ì§€ë¦„ë³´ë‹¤ ë” í¬ê²Œ í•¨ (ë” ë‘ë“œëŸ¬ì§€ê²Œ).
        const v0 = new THREE.Vector3().fromBufferAttribute(positionAttribute, indices[0]).normalize().multiplyScalar(radius * 1.02);
        const v1 = new THREE.Vector3().fromBufferAttribute(positionAttribute, indices[1]).normalize().multiplyScalar(radius * 1.02);
        const v2 = new THREE.Vector3().fromBufferAttribute(positionAttribute, indices[2]).normalize().multiplyScalar(radius * 1.02);

        // ì‚¼ê°í˜• ì •ì  ì •ë³´ë¥¼ ì €ì¥
        if (!window.plotVertices) window.plotVertices = [];
        window.plotVertices.push({
          id: `Plot_${i / 3}`,
          v0: { x: v0.x, y: v0.y, z: v0.z },
          v1: { x: v1.x, y: v1.y, z: v1.z },
          v2: { x: v2.x, y: v2.y, z: v2.z }
        });

        const vertices = new Float32Array([
            v0.x, v0.y, v0.z,
            v1.x, v1.y, v1.z,
            v2.x, v2.y, v2.z
        ]);

        const faceGeometry = new THREE.BufferGeometry();
        faceGeometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
        faceGeometry.setIndex([0, 1, 2]);
        faceGeometry.computeVertexNormals();

        // ì•ˆë³´ì´ê²Œ í•¨.
        const faceMesh = new THREE.Mesh(faceGeometry, new THREE.MeshBasicMaterial({ visible: false }));
        faceMesh.name = `Plot_Triangle_${i / 3}`;
        plotMeshes.push(faceMesh);
        // í´ë¦­ ê°€ëŠ¥í•œ ì‚¼ê°í˜• í‘œì‹œ

        //ì‚¼ê°í˜•ë§ˆë‹¤ ê³ ìœ  id ë¶€ì—¬
        faceMesh.userData = { clickable: true, id: `êµ¬ì—­_${i / 3}` };  
        mars.add(faceMesh);

        // í´ë¦­ ê°ì§€í•˜ëŠ” íˆ¬ëª…í•œ ì‚¼ê°í˜•
        const edgeGeometry = new THREE.BufferGeometry().setFromPoints([
          v0, v1, v2, v0 // ì‚¼ê°í˜•ì„ ë”°ë¼ ì´ì–´ì§€ëŠ” ì„ 
        ]);

        //ì‚¼ê°í˜• ê²½ê³„ì—£ ì„  ë³´ì´ê²Œ í•¨.
        const edgeLine = new THREE.Line(edgeGeometry, new THREE.LineBasicMaterial({ color: 0xffffff }));
        mars.add(edgeLine);
    }
}

function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}
animate();

// Make canvas responsive to window size changes
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});


// ì‚¼ê°í˜• í´ë¦­ ì‹œ goto.htmlë¡œ ì´ë™
window.addEventListener('click', (event) => {
  const mouse = new THREE.Vector2(
    (event.clientX / window.innerWidth) * 2 - 1,
    -(event.clientY / window.innerHeight) * 2 + 1
  );

  const raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(mouse, camera);

  const intersects = raycaster.intersectObjects(plotMeshes);
  if (intersects.length > 0) {
    const obj = intersects[0].object;
    if (obj.userData.clickable) {
      const id = obj.userData.id || 'unknown';
      const plotNumber = parseInt(id.replace('êµ¬ì—­_', ''));
      const x = 3;
      const targetFile = `product_${plotNumber % x}.html`;

      document.getElementById('plot-info').textContent = `${id} êµ¬ì—­ë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤.`;
      // Add description and image update
      const descriptions = {};
      for (let i = 0; i < 80; i++) {
        descriptions[i] = `ì´ ë¶€ì§€ëŠ” í™”ì„±ì˜ ë‹¤ì–‘í•œ ì§€ì—­ ì¤‘ í•˜ë‚˜ë¡œ, êµ¬ì—­_${i}ì— í•´ë‹¹í•©ë‹ˆë‹¤. íƒì‚¬ ë° ê°œë°œ ê°€ëŠ¥ì„±ì´ ë†’ì€ í›„ë³´ì§€ë¡œ í‰ê°€ë˜ê³  ìˆìŠµë‹ˆë‹¤.`;
      }
      const description = descriptions[plotNumber] || "ì´ êµ¬ì—­ì— ëŒ€í•œ ì„¤ëª…ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.";
      document.getElementById('plot-description').textContent = description;

      const img = document.getElementById('plot-img');
      // Log which image is being loaded
      
      //image ë„£ê¸°
      const safePlotNumber = plotNumber < 287 ? plotNumber : Math.floor(plotNumber / 3);
      img.src = `mars_plots_287/plot_${safePlotNumber}.jpg`;
      img.alt = `Plot ${plotNumber} ë¶€ì§€ ì´ë¯¸ì§€`;
      img.title = `Plot ${plotNumber}`;
      img.style.display = 'block';
      const detailsBtn = document.getElementById('details-button');
      detailsBtn.style.display = 'block';
      detailsBtn.onclick = () => {
        sessionStorage.setItem('cameraPosition', JSON.stringify(camera.position));
        sessionStorage.setItem('cameraRotation', JSON.stringify(camera.rotation));
        window.location.href = targetFile;
      };
    }
  }
});

  </script>
</body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</html>
